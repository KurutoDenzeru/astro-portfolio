---
import { WORK } from "@consts";
import { getCollection } from "astro:content";
import BottomLayout from "@layouts/BottomLayout.astro";
import PageLayout from "@layouts/PageLayout.astro";
import TopLayout from "@layouts/TopLayout.astro";
import { Image } from "astro:assets";

const collection = await getCollection("work");

collection.sort(
  (a, b) =>
    new Date(b.data.dateStart).getTime() - new Date(a.data.dateStart).getTime(),
);

type RenderedEntry = (typeof work)[number] | (typeof orgs)[number];

// Function to group entries by company
function groupByCompany(entries: RenderedEntry[]) {
  const groups: { [key: string]: RenderedEntry[] } = {};
  for (const entry of entries) {
    if (!groups[entry.data.company]) {
      groups[entry.data.company] = [];
    }
    groups[entry.data.company].push(entry);
  }

  // Sort positions within each company by date
  for (const group of Object.values(groups)) {
    group.sort(
      (
        a: { data: { dateStart: string | number | Date } },
        b: { data: { dateStart: string | number | Date } },
      ) =>
        new Date(b.data.dateStart).getTime() -
        new Date(a.data.dateStart).getTime(),
    );
  }

  return groups;
}

// Filter collections based on type
const workCollection = collection.filter((item) => item.data.type === "work");
const orgsCollection = collection.filter((item) => item.data.type === "org");

const work = await Promise.all(
  workCollection.map(async (item) => {
    const { Content } = await item.render();
    return { ...item, Content };
  }),
);

const orgs = await Promise.all(
  orgsCollection.map(async (item) => {
    const { Content } = await item.render();
    return { ...item, Content };
  }),
);

const groupedWork = groupByCompany(work);
const groupedOrgs = groupByCompany(orgs);

function formatWorkDate(
  input?: Date | string | number | null,
  treatEmptyAsPresent = false,
) {
  // Handle missing/empty values
  if (input == null || input === "") {
    if (treatEmptyAsPresent) return "Present";
    return "";
  }

  // If number (epoch), convert to Date
  if (typeof input === "number") input = new Date(input);

  // If it's a string, handle 'present' and parseable dates
  if (typeof input === "string") {
    const trimmed = input.trim();
    if (/^present$/i.test(trimmed)) return "Present";
    const parsed = Date.parse(trimmed);
    if (!isNaN(parsed)) input = new Date(parsed);
    else return trimmed; // fallback to raw string if it can't be parsed
  }

  // If it is a Date, format it
  if (input instanceof Date && !isNaN(input.getTime())) {
    const month = input.toLocaleDateString("en-US", { month: "long" });
    const year = input.getFullYear();
    return `${month} ${year}`;
  }

  // Fallback if still invalid
  return "";
}

function calculateDuration(
  startDate?: string | Date | number | null,
  endDate?: string | Date | number | null,
) {
  if (!startDate) return "";

  // Normalize to Date objects where possible
  const toDate = (d?: string | Date | number | null) => {
    if (d == null || d === "") return null;
    if (typeof d === "number") return new Date(d);
    if (typeof d === "string") {
      const trimmed = d.trim();
      if (/^present$/i.test(trimmed)) return "present" as unknown as Date;
      const parsed = Date.parse(trimmed);
      if (!isNaN(parsed)) return new Date(parsed);
      return null;
    }
    if (d instanceof Date) return d;
    return null;
  };

  const start = toDate(startDate) as Date | null;
  let isPresent = false;
  let end = toDate(endDate) as Date | null;
  if (!endDate || end === ("present" as unknown as Date)) {
    isPresent = true;
    end = new Date();
  }

  if (
    !start ||
    isNaN((start as Date).getTime()) ||
    !end ||
    isNaN(end.getTime())
  )
    return "";

  const startYear = start.getFullYear();
  const startMonth = start.getMonth();
  const endYear = end.getFullYear();
  const endMonth = end.getMonth();

  let months = (endYear - startYear) * 12 + (endMonth - startMonth) + 1;
  if (months < 0) months = 0;

  const years = Math.floor(months / 12);
  const remainingMonths = months % 12;

  const parts: string[] = [];
  if (years > 0) parts.push(`${years} yr${years !== 1 ? "s" : ""}`);
  if (remainingMonths > 0)
    parts.push(`${remainingMonths} mo${remainingMonths !== 1 ? "s" : ""}`);

  if (parts.length === 0) return isPresent ? "Less than a month" : "0 mos";
  return parts.join(" ");
}

const breadcrumbLd = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": Astro.site,
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Work",
      "item": new URL(Astro.url.pathname, Astro.site).toString(),
    }
  ],
});
---

<PageLayout title={WORK.TITLE} description={WORK.DESCRIPTION}>
  <script type="application/ld+json" set:html={breadcrumbLd} />
  <TopLayout>
    <div class="animate">
      <h1 class="text-3xl font-semibold text-black dark:text-white mt-2">
        {WORK.TITLE}
      </h1>
      <div class="mt-1">
        {WORK.DESCRIPTION}
      </div>
    </div>
  </TopLayout>

  <!-- Work Experience -->
  <BottomLayout>
    <ul class="space-y-4">
      {
        Object.entries(groupedWork).map(([company, entries], index) => (
          <li class="animate">
            <div
              class={`border-b border-black/10 dark:border-white/25 ${index === Object.keys(groupedWork).length - 1 ? "border-b-0" : ""}`}
            >
              <div class="flex items-start gap-4">
                {entries[0].data.companyImage && (
                  <Image
                    src={entries[0].data.companyImage}
                    alt={company}
                    width="60"
                    height="60"
                    class="rounded-md"
                  />
                )}
                <div class="flex-1">
                  <div class="text-black dark:text-white font-semibold text-lg">
                    {company}
                  </div>
                  <div class="mt-1">
                    {entries.length > 1 ? (
                      <ol class="relative border-s border-gray-200 dark:border-gray-700">
                        {entries.map((entry) => (
                          <li class="ms-4 mb-4">
                            <div class="absolute w-3 h-3 bg-gray-200 rounded-full mt-1.5 -start-1.5 border border-white dark:border-gray-900 dark:bg-gray-700" />
                            <div class="text-black dark:text-white font-semibold">
                              {entry.data.role}
                            </div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                              {formatWorkDate(entry.data.dateStart)} —{" "}
                              {formatWorkDate(entry.data.dateEnd, true)}
                              {" \u00B7 "}
                              {calculateDuration(
                                entry.data.dateStart,
                                entry.data.dateEnd,
                              )}
                            </div>
                            {/* Render Content as a component */}
                            <article class="work-content text-sm mt-2">
                              <entry.Content />
                            </article>
                          </li>
                        ))}
                      </ol>
                    ) : (
                      entries.map((entry) => (
                        <div class="relative">
                          <div>
                            <div class="flex items-center gap-2">
                              <div class="text-black dark:text-white font-semibold">
                                {entry.data.role}
                              </div>
                            </div>

                            <div class="text-sm text-gray-600 dark:text-gray-400">
                              {formatWorkDate(entry.data.dateStart)} —{" "}
                              {formatWorkDate(entry.data.dateEnd, true)}{" "}
                              {" \u00B7 "}
                              {calculateDuration(
                                entry.data.dateStart,
                                entry.data.dateEnd,
                              )}
                            </div>

                            {/* Render Content as a component */}
                            <article class="work-content text-sm mt-2">
                              <entry.Content />
                            </article>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>
            </div>
          </li>
        ))
      }
    </ul>
  </BottomLayout>

  <!-- Organization Affiliations -->
  <BottomLayout>
    <div class="animate page-heading text-2xl">Organization Affiliations</div>
  </BottomLayout>

  <BottomLayout>
    <ul class="space-y-4">
      {
        Object.entries(groupedOrgs).map(([company, entries], index) => (
          <li class="animate">
            <div
              class={`border-b border-black/10 dark:border-white/25 pb-8 ${index === Object.keys(groupedOrgs).length - 1 ? "border-b-0" : ""}`}
            >
              <div class="flex items-start gap-4">
                {entries[0].data.companyImage && (
                  <Image
                    src={entries[0].data.companyImage}
                    alt={company}
                    width="60"
                    height="60"
                    class="rounded-md"
                  />
                )}
                <div class="flex-1">
                  <div class="text-black dark:text-white font-semibold text-lg">
                    {company}
                  </div>
                  <div class="mt-1">
                    {entries.length > 1 ? (
                      <ol class="relative border-s border-gray-200 dark:border-gray-700">
                        {entries.map((entry) => (
                          <li class="mb-10 ms-4">
                            <div class="absolute w-3 h-3 bg-gray-200 rounded-full mt-1.5 -start-1.5 border border-white dark:border-gray-900 dark:bg-gray-700" />
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                              {entry.data.role}
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                              {formatWorkDate(entry.data.dateStart)} —{" "}
                              {formatWorkDate(entry.data.dateEnd, true)}
                              {" \u00B7 "}
                              {calculateDuration(
                                entry.data.dateStart,
                                entry.data.dateEnd,
                              )}
                            </div>
                            {/* Render Content as a component */}
                            <article class="work-content text-sm mt-2">
                              <entry.Content />
                            </article>
                          </li>
                        ))}
                      </ol>
                    ) : (
                      entries.map((entry) => (
                        <div class="relative">
                          <div>
                            <div class="text-black dark:text-white font-semibold">
                              {entry.data.role}
                            </div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                              {formatWorkDate(entry.data.dateStart)} —{" "}
                              {formatWorkDate(entry.data.dateEnd, true)}
                              {" \u00B7 "}
                              {calculateDuration(
                                entry.data.dateStart,
                                entry.data.dateEnd,
                              )}
                            </div>
                            {/* Render Content as a component */}
                            <div class="work-content text-sm mt-2">
                              <entry.Content />
                            </div>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>
            </div>
          </li>
        ))
      }
    </ul>
  </BottomLayout>
</PageLayout>
