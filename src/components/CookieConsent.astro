---
import "@styles/global.css";
import { Button } from "@/components/ui/button";
import { Info } from "lucide-react";
---

<div
  class="fixed right-4 bottom-4 z-10 max-w-sm p-4 bg-card text-card-foreground rounded-lg shadow-lg border dark:bg-card dark:text-card-foreground"
  id="cookie-consent"
  aria-live="polite"
  hidden
>
  <div class="flex items-start gap-3">
    <div class="flex-1">
      <p class="text-sm font-semibold flex items-center gap-2">
          <Info size={16} strokeWidth={2} className="size-4 stroke-current" aria-hidden="true" />
          <span>We use cookies</span>
        </p>
        <p class="mt-1 text-sm text-muted-foreground">
          Anonymous analytics help improve the site. You can accept or reject
          below.
        </p>
        <div class="mt-3 flex items-center gap-2">
        <Button
          id="accept-analytics"
          className="inline-flex items-center gap-2 rounded-md px-3 py-1.5 text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90"
          >Accept</Button
        >
        <Button
          variant="outline"
          id="reject-analytics"
          className="inline-flex items-center gap-2 rounded-md px-3 py-1.5 text-sm font-medium border bg-background hover:bg-accent"
          >Reject</Button
        >
        <a class="ml-2 text-sm underline text-primary" href="/legal/privacy" aria-label="Read our Privacy Policy"
          >Privacy Policy</a
        >
      </div>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    try {
      const storageKey = "site:analytics:consent";
      const el = document.getElementById("cookie-consent");
      const accepted = localStorage.getItem(storageKey);
      function show() {
        if (el) el.hidden = false;
      }
      function hide() {
        if (el) el.hidden = true;
      }

        function loadAnalytics() {
          // Only load analytics on allowed production origins to avoid CORS issues during local dev
          try {
            const allowed = [
              'https://kurtcalacday.vercel.app',
            ];
            // allow a dev override via query param or localStorage flag so you can test locally
            const forceFlag = (function(){
              try {
                if (location.search && location.search.indexOf('forceAnalytics=1') !== -1) return true;
                return localStorage.getItem('site:analytics:force') === 'true';
              } catch (e) {
                return false;
              }
            })();

            if (!allowed.includes(location.origin) && !forceFlag) {
              // skip loading analytics in non-prod (e.g. http://localhost:4321)
              console.info('Analytics not loaded: origin not allowed', location.origin);
              return;
            }
            if (forceFlag && !allowed.includes(location.origin)) {
              console.warn('Analytics load forced in non-prod environment; CORS may still prevent network calls');
            }
          } catch (e) {
            // if location isn't available for some reason, skip
            return;
          }

          // If both providers are already loaded, nothing to do
          if (window.__cloudflare_insights_loaded__ && window.__rybbit_loaded__) return;

          // Cloudflare Insights loader with retries and specific flag
          (function loadCloudflare(retries = 3, delay = 500) {
            if (window.__cloudflare_insights_loaded__ || window.__cloudflare_insights_loading__) return Promise.resolve(window.__cloudflare_insights_loaded__ || false);
            window.__cloudflare_insights_loading__ = true;
            return new Promise((resolve) => {
              function attempt(remaining, wait) {
                try {
                  const s = document.createElement('script');
                  s.defer = true;
                  s.src = 'https://static.cloudflareinsights.com/beacon.min.js';
                  s.setAttribute('data-cf-beacon', '{"token":"b57650f711ec4244813b03101859b932"}');
                  s.onload = function () {
                    console.log('Cloudflare Insights: script loaded and running');
                    try { window.__cloudflare_insights_loaded__ = true; } catch (e) {}
                    window.__cloudflare_insights_loading__ = false;
                    resolve(true);
                  };
                  s.onerror = function (err) {
                    console.error('Cloudflare Insights: failed to load', err);
                    try { s.remove(); } catch (e) {}
                    if (remaining > 0) {
                      console.log('Cloudflare Insights: retrying in', wait, 'ms...');
                      setTimeout(() => attempt(remaining - 1, Math.min(wait * 2, 5000)), wait);
                    } else {
                      window.__cloudflare_insights_loading__ = false;
                      resolve(false);
                    }
                  };
                  document.head.appendChild(s);
                } catch (err) {
                  console.error('Cloudflare Insights: loader error', err);
                  window.__cloudflare_insights_loading__ = false;
                  resolve(false);
                }
              }
              attempt(retries, delay);
            });
          })().then(function (success) {
            if (success) console.log('Cloudflare Insights: confirmed loaded after accept');
            else console.warn('Cloudflare Insights: not detected after accept (failed to load after retries)');
          });

          // Rybbit Analytics (loads only on consent + allowed origin)
          try {
            if (!window.__rybbit_loaded__) {
              const r = document.createElement('script');
              r.defer = true;
              r.src = 'https://app.rybbit.io/api/script.js';
              r.setAttribute('data-site-id', 'a24aab4e28b1');
              r.crossOrigin = 'anonymous';
              r.onload = function () { console.log('Rybbit Analytics: script loaded'); try { window.__rybbit_loaded__ = true; } catch (e) {} };
              r.onerror = function (err) { console.error('Rybbit Analytics: failed to load', err); };
              document.head.appendChild(r);
            }
          } catch (e) {
            /* noop */
          }
        }

      if (accepted === "true") {
        loadAnalytics();
        hide();
      } else if (accepted === "false") {
        hide();
      } else {
        show();
      }

      document.addEventListener("click", function (e) {
        const t = e.target;
        if (!t) return;
        if (t.id === "accept-analytics") {
          localStorage.setItem(storageKey, "true");
          console.log('User accepted analytics â€” attempting to load analytics providers');
          loadAnalytics();
          hide();
        }
        if (t.id === "reject-analytics") {
          localStorage.setItem(storageKey, "false");
          hide();
        }
      });
    } catch (err) {
      /* fail silently */
    }
  })();
</script>
