---
// filepath: /Users/kurtcalacday/Documents/Projects/astro-app/src/components/Header.astro
import Container from "@components/Container.astro";
import CustomTooltip from "@components/CustomTooltip.astro";
import { SITE } from "@consts";
import { cn } from "@lib/utils";

const { pathname } = Astro.url;
const subpath = pathname.match(/[^/]+/g);

// lucide astro icons (server-rendered components, not raw <svg> tags)
import {
  Rss,
  Moon,
  Sun,
  X,
  Search,
  Menu,
  Home,
  Briefcase,
  FolderOpen,
} from "lucide-react";
---

<header
  id="header"
  class="fixed bottom-2 md:bottom-auto md:top-4 left-0 md:left-1/2 md:-translate-x-1/2 right-0 md:right-auto md:w-auto h-20 md:h-auto z-50"
>
  <Container size="lg">
    <div
      class="relative h-full w-full flex items-center justify-center px-4 md:px-0"
    >
      <!-- Center Dock Navigation (Desktop & Mobile) -->
      <nav id="dock-nav" class="flex items-center justify-center gap-2">
        <div class="glass-dock flex items-center gap-2 px-3 py-2 rounded-2xl">
          <!-- Mobile: Logo, Navigation, and Hamburger Menu -->
          <div class="md:hidden flex items-center gap-2">
            <!-- Mobile: Logo -->
            <a
              href="/"
              aria-label="Home"
              class={cn(
                "size-10 rounded-xl p-1.5 flex items-center justify-center",
                "transition-all duration-300 ease-in-out",
                "hover:bg-black/5 dark:hover:bg-white/10",
              )}
            >
              <picture class="size-full">
                <img
                  src="/icons/brand_black.svg"
                  alt={`${SITE.TITLE} logo`}
                  width="40"
                  height="40"
                  class="w-full h-full block dark:hidden"
                  loading="lazy"
                />
                <img
                  src="/icons/brand_white.svg"
                  alt={`${SITE.TITLE} logo`}
                  width="40"
                  height="40"
                  class="w-full h-full hidden dark:block"
                  loading="lazy"
                />
              </picture>
            </a>
            <div class="w-px h-6 bg-black/10 dark:bg-white/20 mx-1"></div>

            <!-- Mobile: Navigation icons only -->
            <CustomTooltip text="Home" side="bottom">
              <a
                href="/"
                aria-label="Home"
                class={cn(
                  "size-10 rounded-xl p-2 flex items-center justify-center",
                  "transition-all duration-300 ease-in-out",
                  pathname === "/"
                    ? "bg-black/10 dark:bg-white/20 scale-110"
                    : "hover:bg-black/5 dark:hover:bg-white/10 hover:scale-105",
                )}
              >
                <Home className="w-5 h-5 text-gray-900 dark:text-white" />
              </a>
            </CustomTooltip>
            <CustomTooltip text="Work" side="bottom">
              <a
                href="/work"
                aria-label="Work"
                class={cn(
                  "size-10 rounded-xl p-2 flex items-center justify-center",
                  "transition-all duration-300 ease-in-out",
                  pathname === "/work" || "/" + subpath?.[0] === "/work"
                    ? "bg-black/10 dark:bg-white/20 scale-110"
                    : "hover:bg-black/5 dark:hover:bg-white/10 hover:scale-105",
                )}
              >
                <Briefcase className="w-5 h-5 text-gray-900 dark:text-white" />
              </a>
            </CustomTooltip>
            <CustomTooltip text="Projects" side="bottom">
              <a
                href="/projects"
                aria-label="Projects"
                class={cn(
                  "size-10 rounded-xl p-2 flex items-center justify-center",
                  "transition-all duration-300 ease-in-out",
                  pathname === "/projects" || "/" + subpath?.[0] === "/projects"
                    ? "bg-black/10 dark:bg-white/20 scale-110"
                    : "hover:bg-black/5 dark:hover:bg-white/10 hover:scale-105",
                )}
              >
                <FolderOpen className="w-5 h-5 text-gray-900 dark:text-white" />
              </a>
            </CustomTooltip>

            <!-- Mobile: Divider before hamburger -->
            <div class="w-px h-6 bg-black/10 dark:bg-white/20 mx-1"></div>

            <!-- Mobile: Hamburger Menu -->
            <button
              id="header-drawer-button"
              aria-label="Toggle drawer open and closed"
              class={cn(
                "size-10 rounded-xl p-2 flex items-center justify-center cursor-pointer",
                "transition-all duration-300 ease-in-out",
                "hover:bg-black/5 dark:hover:bg-white/10 hover:scale-105",
              )}
            >
              <Menu
                id="drawer-open"
                className="text-gray-900 dark:text-white w-5 h-5 cursor-pointer"
              />
              <X
                id="drawer-close"
                className="hidden text-gray-900 dark:text-white w-5 h-5 cursor-pointer"
              />
            </button>
          </div>

          <!-- Desktop Navigation (hidden on mobile) -->
          <div class="hidden md:flex items-center gap-2">
            <!-- Desktop: Logo with label -->
            <a
              href="/"
              class={cn(
                "hidden md:flex items-center gap-2 rounded-xl px-2 py-1.5 cursor-pointer",
                "transition-all duration-300 ease-in-out",
                "hover:bg-black/5 dark:hover:bg-white/10",
                "group overflow-hidden dock-brand",
              )}
            >
              <picture class="size-7 shrink-0">
                <img
                  src="/icons/brand_black.svg"
                  alt={`${SITE.TITLE} logo`}
                  width="28"
                  height="28"
                  class="w-full h-full block dark:hidden"
                  loading="eager"
                />
                <img
                  src="/icons/brand_white.svg"
                  alt={`${SITE.TITLE} logo`}
                  width="28"
                  height="28"
                  class="w-full h-full hidden dark:block"
                  loading="eager"
                />
              </picture>
              <span
                class="dock-label text-sm font-medium text-gray-900 dark:text-white whitespace-nowrap"
              >
                {SITE.TITLE}
              </span>
            </a>
            <div
              class="hidden md:block w-px h-6 bg-black/10 dark:bg-white/20 mx-1"
            >
            </div>

            <!-- Desktop: All icons with expandable labels -->
            <CustomTooltip text="Home">
              <a
                href="/"
                aria-label="Home"
                class={cn(
                  "hidden md:flex items-center gap-2 rounded-xl px-2 py-1.5",
                  "transition-all duration-300 ease-in-out",
                  "group overflow-hidden",
                  pathname === "/"
                    ? "bg-black/10 dark:bg-white/20 dock-active"
                    : "hover:bg-black/5 dark:hover:bg-white/10",
                )}
              >
                <Home
                  className="w-5 h-5 text-gray-900 dark:text-white shrink-0"
                />
              </a>
            </CustomTooltip>
            <CustomTooltip text="Work">
              <a
                href="/work"
                aria-label="Work"
                class={cn(
                  "hidden md:flex items-center gap-2 rounded-xl px-2 py-1.5",
                  "transition-all duration-300 ease-in-out",
                  "group overflow-hidden",
                  pathname === "/work" || "/" + subpath?.[0] === "/work"
                    ? "bg-black/10 dark:bg-white/20 dock-active"
                    : "hover:bg-black/5 dark:hover:bg-white/10",
                )}
              >
                <Briefcase
                  className="w-5 h-5 text-gray-900 dark:text-white shrink-0"
                />
              </a>
            </CustomTooltip>
            <CustomTooltip text="Projects">
              <a
                href="/projects"
                aria-label="Projects"
                class={cn(
                  "hidden md:flex items-center gap-2 rounded-xl px-2 py-1.5",
                  "transition-all duration-300 ease-in-out",
                  "group overflow-hidden",
                  pathname === "/projects" || "/" + subpath?.[0] === "/projects"
                    ? "bg-black/10 dark:bg-white/20 dock-active"
                    : "hover:bg-black/5 dark:hover:bg-white/10",
                )}
              >
                <FolderOpen
                  className="w-5 h-5 text-gray-900 dark:text-white shrink-0"
                />
              </a>
            </CustomTooltip>
            <div
              class="hidden md:block w-px h-6 bg-black/10 dark:bg-white/20 mx-1"
            >
            </div>
            <CustomTooltip text="Search">
              <a
                href="/search"
                aria-label="Search"
                class={cn(
                  "hidden md:flex items-center gap-2 rounded-xl px-2 py-1.5",
                  "transition-all duration-300 ease-in-out",
                  "group overflow-hidden",
                  pathname === "/search" || "/" + subpath?.[0] === "/search"
                    ? "bg-black/10 dark:bg-white/20 dock-active"
                    : "hover:bg-black/5 dark:hover:bg-white/10",
                )}
              >
                <Search
                  className="w-5 h-5 text-gray-900 dark:text-white shrink-0"
                />
              </a>
            </CustomTooltip>
            <CustomTooltip text="Subscribe">
              <a
                href="/rss.xml"
                target="_blank"
                rel="noopener"
                aria-label="Subscribe"
                class={cn(
                  "hidden md:flex items-center gap-2 rounded-xl px-2 py-1.5",
                  "transition-all duration-300 ease-in-out",
                  "group overflow-hidden",
                  "hover:bg-black/5 dark:hover:bg-white/10",
                )}
              >
                <Rss
                  className="w-5 h-5 text-gray-900 dark:text-white shrink-0"
                />
              </a>
            </CustomTooltip>
            <div
              id="theme-tooltip-wrapper"
              class="custom-tooltip-wrapper group relative inline-flex"
            >
              <button
                id="header-theme-button"
                aria-label="Toggle theme"
                class={cn(
                  "hidden md:flex items-center gap-2 rounded-xl px-2 py-1.5",
                  "transition-all duration-300 ease-in-out",
                  "group overflow-hidden",
                  "hover:bg-black/5 dark:hover:bg-white/10",
                  "cursor-pointer",
                )}
              >
                <Sun
                  className="block dark:hidden text-gray-900 w-5 h-5 shrink-0"
                />
                <Moon
                  className="hidden dark:block text-white w-5 h-5 shrink-0"
                />
              </button>

              <!-- Dynamic tooltip for theme button -->
              <div
                id="theme-tooltip"
                class={`
                custom-tooltip
                absolute hidden group-hover:block
                top-full mt-2 left-1/2 -translate-x-1/2
                bg-foreground text-background
                px-3 py-1.5 rounded-md text-xs font-medium whitespace-nowrap
                z-50 pointer-events-none
                animate-in fade-in-0 zoom-in-95 duration-200
                dark:bg-foreground dark:text-background
              `}
                role="tooltip"
              >
                <span id="theme-tooltip-text">Light mode</span>

                <!-- Arrow -->
                <div
                  class={`
                  custom-tooltip-arrow
                  absolute w-0 h-0
                  border-4
                  bottom-full border-b-foreground border-l-transparent border-r-transparent border-t-transparent
                  left-1/2 -translate-x-1/2
                `}
                >
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </div>
  </Container>
</header>

<style>
  #header-drawer-button > #drawer-open {
    @apply block;
  }
  #header-drawer-button > #drawer-close {
    @apply hidden;
  }
  #header-drawer-button.open > #drawer-open {
    @apply hidden;
  }
  #header-drawer-button.open > #drawer-close {
    @apply block;
  }

  /* Brand label: always visible; other labels are removed and replaced with native tooltips */
  .dock-brand .dock-label {
    display: inline-block;
    opacity: 1;
    margin-left: 0.5rem;
    color: inherit;
    font-weight: 600;
  }
</style>

<script type="module">
  import "/js/drawer.js";
  import "/js/theme.js";

  // Update theme tooltip based on current theme
  function updateThemeTooltip() {
    const btn = document.getElementById("header-theme-button");
    const tooltip = document.getElementById("theme-tooltip");
    const tooltipText = document.getElementById("theme-tooltip-text");
    if (!btn || !tooltip || !tooltipText) return;
    const isDark = document.documentElement.classList.contains("dark");
    const label = isDark ? "Dark mode" : "Light mode";
    tooltipText.textContent = label;
    // Helpful for screen readers: include current state
    btn.setAttribute("aria-label", `Toggle theme â€” ${label}`);
  }

  // Initialize theme tooltip on load
  updateThemeTooltip();

  // Update theme tooltip when theme changes
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === "class") {
        updateThemeTooltip();
      }
    });
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["class"],
  });

  // Initialize on load and after Astro swaps
  document.addEventListener("astro:after-swap", () => {
    initializeDrawerButton();
    updateThemeTooltip();
  });
  initializeDrawerButton();
</script>
